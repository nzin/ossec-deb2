#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
#
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.
#
# Modified to make a template file for a multi-binary package with separated
# build-arch and build-indep targets  by Bill Allombert 2001

# Uncomment this to turn on verbose mode.
export DH_VERBOSE=1

# This has to be exported to make some magic below work.
export DH_OPTIONS

PKG_BASENAME="ossec-hids"
CURDIR="`pwd`"

# If we do not say anything we assume a server build
configure: configure-server

# Configure for the server build
configure-server: configure-server-stamp
configure-server-stamp:
	dh_testdir
# TBD - Configure CFLAGS in src/Config.OS?
	echo "CEXTRA=-DDEFAULTDIR=\\\"/var/ossec\\\"" > src/Config.OS
	touch $@

# Configure for the agent build
configure-agent: configure-agent-stamp
configure-agent-stamp:
	dh_testdir
	echo "CEXTRA=-DDEFAULTDIR=\\\"/var/ossec\\\" -DCLIENT" > src/Config.OS
	touch $@

# Configure for the local build
configure-local: configure-local-stamp
configure-local-stamp:
	dh_testdir
	echo "CEXTRA=-DDEFAULTDIR=\"/var/ossec\" -DLOCAL" > src/Config.OS
	touch $@

# Builds all binaries
build: build-server #build-agent

# Build the server
build-server: configure-server build-server-stamp 
build-server-stamp: 
# For Prelude support:
#	cd src && make setprelude
	cd src && make all
	cd src && make build
	mv bin server-bin

	touch $@

# Build the agent
# Note: we need to clean the build first
build-agent: clean-sources configure-agent build-agent-stamp 
build-agent-stamp: 
# We have to clean and rebuild againt to set -DCLIENT
	cd src && make all
	cd src && make build
	mv bin agent-bin
	touch $@

# Build the stand-alone version (local)
# Note: we need to clean the build first
build-local: clean-sources configure-local build-local-stamp 
build-local-stamp: 
# We have to clean and rebuild againt to set -DCLIENT
	cd src && make all
	cd src && make build
	mv bin local-bin
	touch $@

build-indep: build-indep-stamp
build-indep-stamp:
# Nothing to do here, yet
	touch $@

install-arch: build
	dh_testdir
	dh_testroot
	dh_prep -a
	dh_installdirs -a
	dh_installinit -a --name=ossec
# Server files and directories
	install -m 755 server-bin/ossec* debian/ossec-hids-server/usr/lib/ossec
	for file in manage_agents syscheck_update verify-agent-conf  \
		clear_stats list_agents agent_control syscheck_control \
		rootcheck_control ; do \
		install -m 755 server-bin/$$file debian/ossec-hids-server/usr/lib/ossec/ ; \
	done
	cd debian/ossec-hids-server/var/ossec && ln -s ../../usr/lib/ossec/ bin
	cd debian/ossec-hids-server/var/ossec && ln -s ../../etc/ossec/ etc
	cd debian/ossec-hids-server/var/ossec && ln -s ../../var/log/ossec/ logs
	cd debian/ossec-hids-server/var/ossec && ln -s ../../etc/ossec/rules/ rules
	chmod -R 550 debian/ossec-hids-server/var/ossec
	chmod 770 debian/ossec-hids-server/var/ossec/queue/alerts
	chmod 770 debian/ossec-hids-server/var/ossec/queue/ossec
	chmod 750 debian/ossec-hids-server/var/ossec/queue/fts
	chmod 750 debian/ossec-hids-server/var/ossec/queue/syscheck
	chmod 750 debian/ossec-hids-server/var/ossec/queue/rootcheck
	chmod 750 debian/ossec-hids-server/var/ossec/queue/diff
	chmod 755 debian/ossec-hids-server/var/ossec/queue/agent-info
	chmod 755 debian/ossec-hids-server/var/ossec/queue/rids
	chmod 755 debian/ossec-hids-server/var/ossec/queue/agentless
	chmod 750 debian/ossec-hids-server/var/ossec/stats
	chmod 750 debian/ossec-hids-server/var/log/ossec
	chmod -R 550 debian/ossec-hids-server/etc/

	install -m 755 src/init/ossec-server.sh debian/ossec-hids-server/usr/lib/ossec/ossec-control
	install -m 754 src/init/ossec-server.sh debian/ossec-hids-server/etc/init.d/ossec-hids-server

	install -m 750 src/agentlessd/scripts/* debian/ossec-hids-server/var/ossec/agentless/
	# configuration files:
	install -m 640 etc/decoder.xml debian/ossec-hids-server/etc/ossec/
	install -m 640 etc/internal_options.conf debian/ossec-hids-server/etc/ossec/
	install -m 640 src/rootcheck/db/*.txt debian/ossec-hids-server/etc/ossec/shared/
	install -m 640 etc/ossec-server.conf  debian/ossec-hids-server/etc/ossec/ossec.conf
	cp -pr etc/rules/* debian/ossec-hids-server/etc/ossec/rules/
	find debian/ossec-hids-server/etc/ossec/rules/ -type f -exec chmod a-x {} \;
	chmod -R ug=rX,o= debian/ossec-hids-server/etc/ossec/rules/
#	chmod ug-x debian/ossec-hids-server/etc/ossec/rules/*
# These are only for local configuration, not provided upstream
#	install -m 640 etc/local_decoder.xml debian/ossec-hids-server/etc/ossec/
#	install -m 640 etc/local_internal_options.conf debian/ossec-hids-server/etc/ossec/
	# other scripts
	install -m 750 active-response/*.sh debian/ossec-hids-server/var/ossec/active-response/bin/
	install -m 750 active-response/firewalls/*.sh debian/ossec-hids-server/var/ossec/active-response/bin/
# Agent files and directories
	# install -m 755 agent-bin/ossec-agentd debian/ossec-hids-agent/usr/bin/
	# for file in agent-auth ossec-logcollector ossec-syscheckd ossec-execd \
	# 	manage_agents ; do \
	# 	install -m 755 agent-bin/$$file debian/ossec-hids-agent/usr/lib/ossec/ ; \
	# done
	# install -m 755 src/init/ossec-client.sh debian/ossec-hids-server/usr/lib/ossec/ossec-control
	# dh_install -a
	# cd debian/ossec-hids-agent/var/ossec && ln -s ../../usr/lib/ossec/ bin
	# cd debian/ossec-hids-agent/var/ossec && ln -s ../../etc/ossec/ etc
	# cd debian/ossec-hids-agent/var/ossec && ln -s ../../var/log/ossec/ logs
	# chmod 750 debian/ossec-hids-agent/var/log/ossec
	# TODO: Missing configuration files, extract from src/InstallAgent.sh

install-indep: build-indep
	dh_testdir
	dh_testroot
	dh_prep -i
	dh_installdirs -i
	dh_install -i

install: install-arch install-indep

binary: binary-arch binary-indep

binary-arch: build install-arch
	dh_testdir -a
	dh_testroot -a
	dh_installdocs -a 
	dh_installexamples -a
	dh_installdebconf -a
	dh_installman -a 
	dh_installchangelogs -a 
	dh_link -a
	dh_strip -a
	dh_compress -a
	dh_fixperms -a
	dh_makeshlibs -a
	dh_installdeb -a
	dh_perl -a
	dh_shlibdeps -a
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

binary-indep: build-indep install-indep
	dh_testdir -i
	dh_testroot -i
	dh_installdocs -i
	dh_installexamples -i
	dh_installdebconf -i
	dh_installman -i 
	dh_installchangelogs -i
	dh_link -i
	dh_strip -i
	dh_compress -i
	dh_fixperms -i
	dh_makeshlibs -i
	dh_installdeb -i
	dh_perl -i
	dh_shlibdeps -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i


get-orig-source:

clean-sources:
	dh_testdir
	dh_testroot
	cd src && make clean
# Clean up additional auto-generated files
	for file in etc/ossec.mc src/Config.OS \
		src/analysisd/compiled_rules/compiled_rules.h \
		src/analysisd/ossec-logtest src/analysisd/ossec-makelists \
		src/isbigendian src/isbigendian.c ; do \
		[ -e $$file ] && rm -f $$file || true; \
		done

clean: clean-sources
	dh_testdir
	dh_testroot
	-rm -rf bin/ server-bin/ agent-bin/ local-bin/
	-rm -f install
	dh_clean


#%:
#	dh $@ 
